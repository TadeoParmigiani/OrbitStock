{% extends 'index.html' %}
{% load static %}

{% block content %}
<!-- Encabezado de contenido -->
<div class="content-header">
    <div class="container-fluid">
        <div class="row mb-2">
            <div class="col-sm-6">
                <h1 class="m-0">Gesti√≥n de Ventas</h1>
            </div>
            <div class="col-sm-6">
                <ol class="breadcrumb float-sm-right">
                    <li class="breadcrumb-item"><a href="/home/list">Inicio</a></li>
                    <li class="breadcrumb-item active">Ventas</li>
                </ol>
            </div>
        </div>
    </div>
</div>

<!-- Contenido principal -->
<section class="content">
    <div class="container-fluid">
        {% if messages %}
        <div class="row">
            <div class="col-12">
                {% for message in messages %}
                <div class="alert alert-{{ message.tags }} alert-dismissible fade show">
                    {{ message }}
                    <button type="button" class="close" data-dismiss="alert">
                        <span>&times;</span>
                    </button>
                </div>
                {% endfor %}
            </div>
        </div>
        {% endif %}

        <!-- Listado de Ventas -->
        <div class="row">
            <div class="col-md-12">
                <div class="card">
                    <div class="card-header">
                        <h3 class="card-title">Ventas</h3>
                        <div class="card-tools">
                            <button type="button" class="btn btn-primary" id="btnNuevaVenta">
                                <i class="fas fa-plus"></i> Nueva Venta
                            </button>
                        </div>
                    </div>
                    <!-- /.card-header -->
                    
                    <div class="card-body">
                        <table id="mi-tabla" class="table table-bordered table-striped">
                            <thead>
                                <tr>
                                    <th>Cliente</th>
                                    <th>Fecha</th>
                                    <th>Total</th>
                                    <th>Productos</th>
                                    <th>M√©todo de Pago</th>
                                    <th>Acciones</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for venta in ventas %}
                                <tr>
                                    <td>{{ venta.cliente.nombre }}</td>
                                    <td>{{ venta.fecha }}</td>
                                    <td>${{ venta.total }}</td>
                                    <td>
                                        <!-- Bot√≥n para ver productos -->
                                        <button type="button" class="btn btn-info btn-sm ver-productos-btn"
                                                data-venta-id="{{ venta.id }}">
                                            Ver productos
                                        </button>
                                    </td>
                                    <td>{{ venta.metodo_pago }}</td>
                                    <td>
                                        <!-- Bot√≥n editar -->
                                        <button type="button" class="btn btn-warning btn-sm edit-venta-btn"
                                                data-id="{{ venta.id }}"
                                                data-cliente-id="{{ venta.cliente.id }}"
                                                data-fecha="{{ venta.fecha|date:'Y-m-d' }}"
                                                data-metodo-pago="{{ venta.metodo_pago }}">
                                            <i class="fas fa-edit"></i> Editar
                                        </button>

                                        <!-- Bot√≥n eliminar -->
                                        <button type="button" class="btn btn-danger btn-sm delete-venta-btn"
                                                data-id="{{ venta.id }}"
                                                data-cliente="{{ venta.cliente.nombre }}">
                                            <i class="fas fa-trash-alt"></i> Eliminar
                                        </button>
                                    </td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                    <!-- /.card-body -->
                </div>
            </div>
        </div>
    </div>
</section>

<!-- Modal Nueva Venta -->
<div class="modal fade" id="addVentaModal" tabindex="-1" role="dialog">
    <div class="modal-dialog modal-lg" role="document">
        <div class="modal-content">
            <form id="formAgregarVenta" method="POST" action="{% url 'saleCreate' %}">
                {% csrf_token %}
                <div class="modal-header">
                    <h5 class="modal-title">Nueva Venta</h5>
                    <button type="button" class="close" data-dismiss="modal">
                        <span>&times;</span>
                    </button>
                </div>
                <div class="modal-body">
                    <div class="form-group">
                        <label for="cliente">Cliente</label>
                        <select id="cliente" name="cliente" class="form-control" required>
                            <option value="">Seleccione un cliente</option>
                            {% for cliente in clientes %}
                                <option value="{{ cliente.id }}">{{ cliente.nombre }}</option>
                            {% endfor %}
                        </select>
                        <div class="invalid-feedback">Seleccione un cliente.</div>
                    </div>

                    <div class="form-group">
                        <label for="fecha">Fecha</label>
                        <input type="date" id="fecha" name="fecha" class="form-control" required>
                        <div class="invalid-feedback">Seleccione una fecha.</div>
                    </div>

                    <div class="form-group">
                        <label for="metodo_pago">M√©todo de Pago</label>
                        <select id="metodo_pago" name="metodo_pago" class="form-control" required>
                            <option value="">Seleccione un m√©todo</option>
                            <option value="Efectivo">Efectivo</option>
                            <option value="Tarjeta">Tarjeta</option>
                            <option value="Transferencia">Transferencia</option>
                        </select>
                        <div class="invalid-feedback">Seleccione un m√©todo de pago.</div>
                    </div>

                    <div class="form-group">
                        <label>Productos</label>
                        <div id="productosContainer">
                            <div class="form-row align-items-center mb-2 producto-item">
                                <div class="col-7">
                                    <select name="producto[]" class="form-control producto-select" required>
                                        <option value="">Seleccione producto</option>
                                        {% for producto in productos %}
                                            <option value="{{ producto.id }}" data-precio="{{ producto.precio_venta }}">
                                                {{ producto.nombre }} - ${{ producto.precio_venta }}
                                            </option>
                                        {% endfor %}
                                    </select>
                                    <div class="invalid-feedback">Seleccione un producto.</div>
                                </div>
                                <div class="col-3">
                                    <input type="number" name="cantidad[]" class="form-control cantidad-input" placeholder="Cantidad" min="1" required>
                                    <div class="invalid-feedback">Ingrese una cantidad v√°lida.</div>
                                </div>
                                <div class="col-2">
                                    <button type="button" class="btn btn-danger btn-sm remove-producto">&times;</button>
                                </div>
                            </div>
                        </div>
                        <button type="button" class="btn btn-info btn-sm mt-2" id="addProducto">
                            <i class="fas fa-plus"></i> Agregar producto
                        </button>
                    </div>

                    <div class="form-group">
                        <label for="total">Total</label>
                        <div class="input-group">
                            <div class="input-group-prepend">
                                <span class="input-group-text">$</span>
                            </div>
                            <input type="number" id="total" name="total" class="form-control" readonly step="0.01">
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="submit" class="btn btn-success">Guardar</button>
                    <button type="button" class="btn btn-secondary" data-dismiss="modal">Cancelar</button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Modal Editar Venta -->
<div class="modal fade" id="editVentaModal" tabindex="-1" role="dialog">
    <div class="modal-dialog modal-lg" role="document">
        <div class="modal-content">
            <form id="formEditarVenta" method="POST" action="">
                {% csrf_token %}
                <div class="modal-header">
                    <h5 class="modal-title">Editar Venta</h5>
                    <button type="button" class="close" data-dismiss="modal">
                        <span>&times;</span>
                    </button>
                </div>
                <div class="modal-body">
                    <input type="hidden" id="edit-venta-id" name="id">

                    <div class="form-group">
                        <label for="edit-cliente">Cliente</label>
                        <select id="edit-cliente" name="id_cliente" class="form-control" required>
                            <option value="">Seleccione un cliente</option>
                            {% for cliente in clientes %}
                                <option value="{{ cliente.id }}">{{ cliente.nombre }} {{ cliente.apellido }}</option>
                            {% endfor %}
                        </select>
                        <div class="invalid-feedback">Seleccione un cliente v√°lido.</div>
                    </div>

                    <div class="form-group">
                        <label for="edit-fecha">Fecha</label>
                        <input type="date" id="edit-fecha" name="fecha" class="form-control" required>
                        <div class="invalid-feedback">Ingrese una fecha v√°lida.</div>
                    </div>

                    <div class="form-group">
                        <label for="edit-metodo-pago">M√©todo de Pago</label>
                        <select id="edit-metodo-pago" name="metodo_pago" class="form-control" required>
                            <option value="">Seleccione un m√©todo</option>
                            <option value="Efectivo">Efectivo</option>
                            <option value="Tarjeta">Tarjeta</option>
                            <option value="Transferencia">Transferencia</option>
                        </select>
                        <div class="invalid-feedback">Seleccione un m√©todo de pago v√°lido.</div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="submit" class="btn btn-primary">Guardar Cambios</button>
                    <button type="button" class="btn btn-secondary" data-dismiss="modal">Cancelar</button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Modal Ver Productos -->
<div class="modal fade" id="verProductosModal" tabindex="-1" role="dialog">
    <div class="modal-dialog modal-lg" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Productos de la venta #<span id="venta-numero"></span></h5>
                <button type="button" class="close" data-dismiss="modal">
                    <span>&times;</span>
                </button>
            </div>
            <div class="modal-body">
                <table class="table table-bordered">
                    <thead>
                        <tr>
                            <th>Producto</th>
                            <th>Cantidad</th>
                            <th>Precio Unitario</th>
                            <th>Subtotal</th>
                        </tr>
                    </thead>
                    <tbody id="productos-venta-body">
                        <!-- Se llena din√°micamente via AJAX -->
                    </tbody>
                    <tfoot>
                        <tr class="font-weight-bold">
                            <td colspan="3" class="text-right">Total:</td>
                            <td id="total-venta">$0.00</td>
                        </tr>
                    </tfoot>
                </table>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-primary editar-productos-btn" id="btnEditarProductos">
                    <i class="fas fa-edit"></i> Editar productos
                </button>
                <button type="button" class="btn btn-secondary" data-dismiss="modal">Cerrar</button>
            </div>
        </div>
    </div>
</div>

<!-- Modal Editar Productos -->
<div class="modal fade" id="editarProductosModal" tabindex="-1" role="dialog">
    <div class="modal-dialog modal-lg" role="document">
        <div class="modal-content">
            <form id="formEditarProductos" method="POST" action="">
                {% csrf_token %}
                <!-- üî• Campo hidden para enviar el total actualizado -->
                <input type="hidden" id="hidden-total-venta" name="total_venta" value="">
                
                <div class="modal-header">
                    <h5 class="modal-title">Editar Productos de la Venta</h5>
                    <button type="button" class="close" data-dismiss="modal">
                        <span>&times;</span>
                    </button>
                </div>
                <div class="modal-body">
                    <div class="alert alert-info">
                        <i class="fas fa-info-circle"></i> 
                        Al modificar las cantidades, el total se actualizar√° autom√°ticamente.
                    </div>
                    
                    <table class="table table-bordered">
                        <thead>
                            <tr>
                                <th>Producto</th>
                                <th>Cantidad</th>
                                <th>Precio Unitario</th>
                                <th>Subtotal</th>
                            </tr>
                        </thead>
                        <tbody id="editar-productos-body">
                            <!-- Se llena din√°micamente via AJAX -->
                        </tbody>
                        <tfoot>
                            <tr class="font-weight-bold bg-light">
                                <td colspan="3" class="text-right">
                                    <strong>Total:</strong>
                                </td>
                                <td>
                                    <strong>$<span id="total-editar-productos">0.00</span></strong>
                                </td>
                            </tr>
                        </tfoot>
                    </table>
                </div>
                <div class="modal-footer">
                    <button type="submit" class="btn btn-success">
                        <i class="fas fa-save"></i> Guardar Cambios
                    </button>
                    <button type="button" class="btn btn-secondary" data-dismiss="modal">
                        <i class="fas fa-times"></i> Cancelar
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Modal Confirmar Eliminaci√≥n -->
<div class="modal fade" id="deleteVentaModal" tabindex="-1" role="dialog">
    <div class="modal-dialog" role="document">
        <div class="modal-content">
            <form id="formEliminarVenta" method="POST" action="">
                {% csrf_token %}
                <div class="modal-header">
                    <h5 class="modal-title">Confirmar Eliminaci√≥n</h5>
                    <button type="button" class="close" data-dismiss="modal">
                        <span>&times;</span>
                    </button>
                </div>
                <div class="modal-body">
                    <input type="hidden" id="delete-venta-id" name="id">
                    <p>¬øEst√° seguro que desea eliminar la venta del cliente <strong id="delete-venta-cliente"></strong>?</p>
                    <p class="text-warning"><i class="fas fa-exclamation-triangle"></i> Esta acci√≥n no se puede deshacer.</p>
                </div>
                <div class="modal-footer">
                    <button type="submit" class="btn btn-danger">S√≠, Eliminar</button>
                    <button type="button" class="btn btn-secondary" data-dismiss="modal">Cancelar</button>
                </div>
            </form>
        </div>
    </div>
</div>

<script>

function waitForJQuery() {
    if (typeof $ !== 'undefined') {
        initVentas();
    } else {
        setTimeout(waitForJQuery, 100);
    }
}

function initVentas() {
    console.log('Script ventas iniciado');
    console.log('jQuery disponible:', typeof $ !== 'undefined');
    console.log('Bootstrap modal disponible:', typeof $.fn.modal !== 'undefined');
    
    // Inicializar fecha actual
    var today = new Date().toISOString().split('T')[0];
    $('#fecha').val(today);
    
    // Bot√≥n Nueva Venta
    $('#btnNuevaVenta').click(function() {
        console.log('Click en Nueva Venta');
        $('#formAgregarVenta')[0].reset();
        $('#formAgregarVenta').removeClass('was-validated');
        
        // Resetear productos a solo uno
        $('#productosContainer').html(`
            <div class="form-row align-items-center mb-2 producto-item">
                <div class="col-7">
                    <select name="producto[]" class="form-control producto-select" required>
                        <option value="">Seleccione producto</option>
                        {% for producto in productos %}
                            <option value="{{ producto.id }}" data-precio="{{ producto.precio_venta }}">
                                {{ producto.nombre }} - ${{ producto.precio_venta }}
                            </option>
                        {% endfor %}
                    </select>
                    <div class="invalid-feedback">Seleccione un producto.</div>
                </div>
                <div class="col-3">
                    <input type="number" name="cantidad[]" class="form-control cantidad-input" placeholder="Cantidad" min="1" required>
                    <div class="invalid-feedback">Ingrese una cantidad v√°lida.</div>
                </div>
                <div class="col-2">
                    <button type="button" class="btn btn-danger btn-sm remove-producto">&times;</button>
                </div>
            </div>
        `);
        
        $('#fecha').val(today);
        calcularTotal();
        $('#addVentaModal').modal('show');
    });

    // Botones Editar Venta
    $('.edit-venta-btn').click(function() {
        console.log('Click en Editar Venta');
        var data = $(this).data();
        
        // Actualizar action del formulario
        $('#formEditarVenta').attr('action', '/sales/update/' + data.id + '/');
        
        $('#edit-venta-id').val(data.id);
        $('#edit-cliente').val(data.clienteId);
        $('#edit-fecha').val(data.fecha);
        $('#edit-metodo-pago').val(data.metodoPago);
        
        $('#formEditarVenta').removeClass('was-validated');
        $('#editVentaModal').modal('show');
    });

    // Botones Eliminar
    $('.delete-venta-btn').click(function() {
        console.log('Click en Eliminar Venta');
        var id = $(this).data('id');
        var cliente = $(this).data('cliente');
        
        $('#formEliminarVenta').attr('action', '/sales/delete/' + id + '/');
        $('#delete-venta-id').val(id);
        $('#delete-venta-cliente').text(cliente);
        $('#deleteVentaModal').modal('show');
    });

    // Ver productos de una venta
    $('.ver-productos-btn').click(function() {
        var ventaId = $(this).data('venta-id');
        console.log('Ver productos de venta:', ventaId);
        
        $('#venta-numero').text(ventaId);
        cargarProductosVenta(ventaId);
        $('#verProductosModal').modal('show');
    });

    // Editar productos desde el modal de ver productos
    $(document).on('click', '#btnEditarProductos', function() {
        var ventaId = $('#venta-numero').text();
        console.log('Editar productos de venta:', ventaId);
        
        $('#verProductosModal').modal('hide');
        setTimeout(function() {
            cargarProductosParaEditar(ventaId);
            $('#editarProductosModal').modal('show');
        }, 300);
    });

    // Agregar producto en formulario de nueva venta
    $('#addProducto').click(function() {
        console.log('Agregar producto');
        var newItem = $('#productosContainer .producto-item:first').clone();
        newItem.find('select').val('');
        newItem.find('input').val('');
        newItem.find('.is-invalid').removeClass('is-invalid');
        $('#productosContainer').append(newItem);
        calcularTotal();
    });

    // Remover producto
    $(document).on('click', '.remove-producto', function() {
        var items = $('#productosContainer .producto-item');
        if (items.length > 1) {
            $(this).closest('.producto-item').remove();
            calcularTotal();
        } else {
            alert('Debe mantener al menos un producto');
        }
    });

    // Calcular total cuando cambian productos o cantidades
    $(document).on('change input', '.producto-select, .cantidad-input', function() {
        calcularTotal();
    });

    // Calcular total en modal de editar productos
    $(document).on('change input keyup', '.cantidad-editar-input', function() {
        console.log('Cambio en cantidad detectado');
        calcularTotalEditarProductos();
    });

    // Funci√≥n para calcular total en nueva venta
    function calcularTotal() {
        var total = 0;
        $('#productosContainer .producto-item').each(function() {
            var precio = parseFloat($(this).find('.producto-select option:selected').data('precio')) || 0;
            var cantidad = parseFloat($(this).find('.cantidad-input').val()) || 0;
            total += precio * cantidad;
        });
        $('#total').val(total.toFixed(2));
    }

    // Funci√≥n para cargar productos de una venta 
    function cargarProductosVenta(ventaId) {
        console.log('Cargando productos para venta:', ventaId);
        
        // Mostrar loading
        $('#productos-venta-body').html('<tr><td colspan="4" class="text-center"><i class="fas fa-spinner fa-spin"></i> Cargando productos...</td></tr>');
        $('#total-venta').text('Cargando...');
        
        
        $.ajax({
            url: '/sales/get-products/' + ventaId + '/',
            type: 'GET',
            dataType: 'json',
            success: function(response) {
                console.log('Respuesta del servidor:', response);
                
                if (response.success) {
                    var html = '';
                    
                    if (response.productos.length > 0) {
                        response.productos.forEach(function(producto) {
                            html += `
                                <tr>
                                    <td>${producto.nombre}</td>
                                    <td>${producto.cantidad}</td>
                                    <td>$${producto.precio_unitario.toFixed(2)}</td>
                                    <td>$${producto.subtotal.toFixed(2)}</td>
                                </tr>
                            `;
                        });
                        $('#total-venta').text('$' + response.total.toFixed(2));
                    } else {
                        html = '<tr><td colspan="4" class="text-center text-muted">No hay productos en esta venta</td></tr>';
                        $('#total-venta').text('$0.00');
                    }
                    
                    $('#productos-venta-body').html(html);
                    
                } else {
                    $('#productos-venta-body').html('<tr><td colspan="4" class="text-center text-danger">Error: ' + response.error + '</td></tr>');
                    $('#total-venta').text('Error');
                }
            },
            error: function(xhr, status, error) {
                console.error('Error en AJAX:', error);
                $('#productos-venta-body').html('<tr><td colspan="4" class="text-center text-danger">Error al cargar los productos</td></tr>');
                $('#total-venta').text('Error');
            }
        });
    }

    // Funci√≥n para cargar productos para editar
    function cargarProductosParaEditar(ventaId) {
        console.log('Cargando productos para editar, venta:', ventaId);
        
        $('#formEditarProductos').attr('action', '/sales/update-products/' + ventaId + '/');
        
        // Mostrar loading
        $('#editar-productos-body').html('<tr><td colspan="4" class="text-center"><i class="fas fa-spinner fa-spin"></i> Cargando productos...</td></tr>');
        $('#total-editar-productos').text('Cargando...');
        
        
        $.ajax({
            url: '/sales/get-products/' + ventaId + '/',
            type: 'GET',
            dataType: 'json',
            success: function(response) {
                console.log('Respuesta para editar:', response);
                
                if (response.success) {
                    var html = '';
                    
                    if (response.productos.length > 0) {
                        response.productos.forEach(function(producto) {
                            html += `
                                <tr>
                                    <td>
                                        ${producto.nombre}
                                        <input type="hidden" name="producto[]" value="${producto.id}">
                                    </td>
                                    <td>
                                        <input type="number" name="cantidad[]" 
                                               class="form-control cantidad-editar-input" 
                                               value="${producto.cantidad}" 
                                               min="1" 
                                               step="1"
                                               data-precio="${producto.precio_unitario}"
                                               required>
                                    </td>
                                    <td class="precio-unitario">$${producto.precio_unitario.toFixed(2)}</td>
                                    <td class="subtotal-editar">$${producto.subtotal.toFixed(2)}</td>
                                </tr>
                            `;
                        });
                    } else {
                        html = '<tr><td colspan="4" class="text-center text-muted">No hay productos en esta venta</td></tr>';
                    }
                    
                    $('#editar-productos-body').html(html);
                    
                    
                    setTimeout(function() {
                        // Agregar campos hidden para subtotales
                        $('#editar-productos-body tr').each(function() {
                            var $row = $(this);
                            var subtotalText = $row.find('.subtotal-editar').text().replace('$', '');
                            var subtotal = parseFloat(subtotalText) || 0;
                            $row.append('<input type="hidden" name="subtotal[]" value="' + subtotal.toFixed(2) + '">');
                        });
                        
                        calcularTotalEditarProductos();
                    }, 100);
                    
                } else {
                    $('#editar-productos-body').html('<tr><td colspan="4" class="text-center text-danger">Error: ' + response.error + '</td></tr>');
                    $('#total-editar-productos').text('0.00');
                    $('#hidden-total-venta').val('0.00');
                }
            },
            error: function(xhr, status, error) {
                console.error('Error en AJAX para editar:', error);
                $('#editar-productos-body').html('<tr><td colspan="4" class="text-center text-danger">Error al cargar los productos</td></tr>');
                $('#total-editar-productos').text('0.00');
                $('#hidden-total-venta').val('0.00');
            }
        });
    }

    // calcula total en editar productos
    function calcularTotalEditarProductos() {
        console.log('Calculando total en editar productos...');
        var total = 0;
        
        $('#editar-productos-body tr').each(function() {
            var $row = $(this);
            var precioText = $row.find('.precio-unitario').text().replace('$', '');
            var precio = parseFloat(precioText) || 0;
            var cantidad = parseFloat($row.find('.cantidad-editar-input').val()) || 0;
            var subtotal = precio * cantidad;
            
            // Actualiza subtotal mostrado
            $row.find('.subtotal-editar').text('$' + subtotal.toFixed(2));
            
            // Actualiza el campo hidden subtotal[]
            var $hiddenSubtotal = $row.find('input[name="subtotal[]"]');
            if ($hiddenSubtotal.length > 0) {
                $hiddenSubtotal.val(subtotal.toFixed(2));
            } else {
                
                $row.append('<input type="hidden" name="subtotal[]" value="' + subtotal.toFixed(2) + '">');
            }
            
            total += subtotal;
            
            console.log('Fila:', {
                precio: precio,
                cantidad: cantidad,
                subtotal: subtotal,
                total_acumulado: total
            });
        });
        
        $('#total-editar-productos').text(total.toFixed(2));
        
        // campo hidden del total
        $('#hidden-total-venta').val(total.toFixed(2));
        
        console.log('Total final calculado:', total.toFixed(2));
    }

    // Validaci√≥n de formularios
    $('form[id^="form"]').submit(function(e) {
        var form = this;
        console.log('Submit formulario:', form.id);
        
        // Validar campos requeridos
        var isValid = true;
        $(form).find('[required]').each(function() {
            if (!this.value.trim()) {
                isValid = false;
                $(this).addClass('is-invalid');
            } else {
                $(this).removeClass('is-invalid');
            }
        });

        // Validaci√≥n especial para formulario de nueva venta
        if (form.id === 'formAgregarVenta') {
            // Verificar que hay al menos un producto con cantidad
            var hasValidProducts = false;
            $('#productosContainer .producto-item').each(function() {
                var producto = $(this).find('.producto-select').val();
                var cantidad = $(this).find('.cantidad-input').val();
                if (producto && cantidad && parseInt(cantidad) > 0) {
                    hasValidProducts = true;
                }
            });
            
            if (!hasValidProducts) {
                alert('Debe agregar al menos un producto con cantidad v√°lida');
                isValid = false;
            }
        }

        // Validaci√≥n especial para formulario de editar productos
        if (form.id === 'formEditarProductos') {
            console.log('Validando formulario de editar productos');
            
            // Verificar que todas las cantidades sean v√°lidas
            var hasValidQuantities = true;
            $('#editar-productos-body .cantidad-editar-input').each(function() {
                var cantidad = parseInt($(this).val());
                if (!cantidad || cantidad < 1) {
                    hasValidQuantities = false;
                    $(this).addClass('is-invalid');
                } else {
                    $(this).removeClass('is-invalid');
                }
            });
            
            if (!hasValidQuantities) {
                alert('Todas las cantidades deben ser n√∫meros mayores a 0');
                isValid = false;
            }
            
            // Recalcular una vez m√°s antes de enviar para asegurar datos correctos
            calcularTotalEditarProductos();
        }

        if (!isValid) {
            e.preventDefault();
            $(form).addClass('was-validated');
            return false;
        }
        
        // Si todo est√° bien, mostrar loading
        var submitBtn = $(form).find('[type="submit"]');
        var originalText = submitBtn.html();
        submitBtn.html('<i class="fas fa-spinner fa-spin"></i> Guardando...').prop('disabled', true);
        
        // Restaurar bot√≥n despu√©s de 3 segundos (por si hay error)
        setTimeout(function() {
            submitBtn.html(originalText).prop('disabled', false);
        }, 3000);
    });

    // Auto-cerrar alertas despu√©s de 5 segundos
    setTimeout(function() {
        $('.alert').alert('close');
    }, 5000);

    // Debug: Mostrar datos del formulario antes de enviar 
    $('#formEditarProductos').submit(function(e) {
        console.log('=== DATOS QUE SE ENV√çAN ===');
        var formData = new FormData(this);
        for (var pair of formData.entries()) {
            console.log(pair[0] + ': ' + pair[1]);
        }
        console.log('========================');
    });
}

// Iniciar cuando la p√°gina est√© lista
if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', waitForJQuery);
} else {
    waitForJQuery();
}
</script>

{% endblock %}